--- 
title: "Homework 3 : the spread of COVID-19"
author: "Mathieu Eug√©nie, Marin Maeva"
date: "`r format(Sys.time(), '%d %B, %Y')`"
site: bookdown::bookdown_site
output: bookdown::html_document2
documentclass: book
bibliography: [references.bib, packages.bib]
biblio-style: apalike
link-citations: yes
---
```{r include=FALSE, cache=FALSE}
#############################################
## The following loads the needed packages ##
#############################################

# load the required packages
packages <- c(
  "here", # for the project's organization
  "tidyverse", "lubridate", # for wrangling
  "modelr", "broom", # for modeling
  "ggrepel", "gghighlight", "patchwork", "maps", # for plotting
  "knitr", "kableExtra", "bookdown", "rmarkdown" # for the report
)
purrr::walk(packages, library, character.only = TRUE)

# automatically create a bib database for R packages
write_bib(.packages(), here::here("packages.bib"))

######################################################
## The following sets a few option for nice reports ##
######################################################

# general options
options(
  digits = 3,
  str = strOptions(strict.width = "cut"),
  width = 69,
  tibble.width = 69,
  cli.unicode = FALSE
)

# ggplot options
theme_set(theme_light())

# knitr options
opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  fig.retina = 0.8, # figures are either vectors or 300 dpi diagrams
  dpi = 300,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,
  fig.show = "hold",
  message = FALSE,
  echo = FALSE
)

######################################################
## The following sets a few option for nice reports ##
######################################################

pval_star <- function (p, cutoffs = c(0.05, 0.01, 0.001)) {
  stopifnot(length(cutoffs) == 3)
  if (length(p) > 1) {
    sapply(p, pval_star, cutoffs = cutoffs)
  }
  else {
    ifelse(p > cutoffs[1], "", ifelse(p > cutoffs[2], 
                                      " *", 
                                      ifelse(p > cutoffs[3], 
                                             " **", 
                                             " ***")))
  }
}
```

# Basic instructions

To obtain the maximum number of points, use whenever possible:

* the pipeline symbol %>%,
* `dplyr` verbs,
* `kable` to print tables,
* `ggplot` to produce the figures,
* `purrr`'s functions to minimize code duplication,
* `broom`'s functions to format the results model fits.

Also: 

* Pay attention to the general aesthetics of your report (i.e., formatting of 
the tables, sizing of the figures, etc.). 
* Use inline code to display single numbers, and `echo = FALSE` for code chunks when you display 
a table of produce a figure (i.e., we don't want to see code unless it is necessary).
* Minimize the amount of code duplication by using iterations concepts and list-columns.
* Comment your code to explain what you are doing.

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
#############################################
## The following loads the needed packages ##
#############################################

# load the required packages
packages <- c(
  "here", # for the project's organization
  "tidyverse", "lubridate", # for wrangling
  "modelr", "broom", # for modeling
  "ggrepel", "gghighlight", "patchwork", "maps", # for plotting
  "knitr", "kableExtra", "bookdown", "rmarkdown" # for the report
)
purrr::walk(packages, library, character.only = TRUE)

# automatically create a bib database for R packages
write_bib(.packages(), here::here("packages.bib"))

######################################################
## The following sets a few option for nice reports ##
######################################################

# general options
options(
  digits = 3,
  str = strOptions(strict.width = "cut"),
  width = 69,
  tibble.width = 69,
  cli.unicode = FALSE
)

# ggplot options
theme_set(theme_light())

# knitr options
opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  fig.retina = 0.8, # figures are either vectors or 300 dpi diagrams
  dpi = 300,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,
  fig.show = "hold",
  message = FALSE,
  echo = FALSE
)

######################################################
## The following sets a few option for nice reports ##
######################################################

pval_star <- function (p, cutoffs = c(0.05, 0.01, 0.001)) {
  stopifnot(length(cutoffs) == 3)
  if (length(p) > 1) {
    sapply(p, pval_star, cutoffs = cutoffs)
  }
  else {
    ifelse(p > cutoffs[1], "", ifelse(p > cutoffs[2], 
                                      " *", 
                                      ifelse(p > cutoffs[3], 
                                             " **", 
                                             " ***")))
  }
}
```
# Introduction

## The data

```{r data}
library(tidyverse)
# all the files from the data folder
files <- "data" %>%
  here::here() %>%
  list.files(full.names = TRUE)

# latest data file
latest_data <- files %>%
  str_subset("jh_covid19_data") %>%
  str_extract("\\d{4}-\\d{2}-\\d{2}") %>%
  max(na.rm = TRUE)

# load the latest data
covid19_data <- files %>%
  str_subset("jh_covid19_data") %>%
  str_subset(latest_data) %>%
  read_csv()

# load the worldbank data
worldbank_data <- files %>%
  str_subset("jh_add_wbank_data") %>%
  read_csv()

# join the covid19 and worldbank datasets
covid19_data <- covid19_data %>%
  inner_join(
    worldbank_data,
    by = "iso3c"
  )
```

For this assignment, we use COVID-19 data provided by [Johns Hopkins University (updated daily)](https://github.com/CSSEGISandData/COVID-19), as well as 
data from the world bank with demographic information.
More specifically, we use daily records of total confirmed infection cases (or cumulative number of cases), total number of fatalities (or cumulative number of deaths) per country starting from `r min(covid19_data$date)` until `r max(covid19_data$date)`. 
The dataset, downloaded on `r latest_data`, contains `r format(nrow(covid19_data), big.mark = ",")` observations and `r ncol(covid19_data)` variables (`r names(covid19_data)`).
<!-- Further, we have access to world bank data with `r nrow(worldbank_data)` rows and `r ncol(worldbank_data)` columns (`r names(worldbank_data)`) with demographic information per country. -->

## A note on Epidemiological Models

Today's epidemiological models are mostly described by so called __*SIR*__-like models [see details in @Martcheva2015, pp.9--12]. In this class of models, the population is divided into three groups:

* *(__S__)usceptible* --- people, might get infected;
* *(__I__)nfectious* --- people, who carry the infection and can infect others;
* *(__R__)ecovered/(__R__)emoved* --- people, who have already recovered from the disease and got immunity.

The SIR model is a system of ordinary nonlinear differential equations. In this homework, we focus on the following *logistic* model [see @Batista2020, pp. 2; @Martcheva2015, pp. 35--36]:

\[
  \frac{dC(t)}{dt} = r \, C(t) \cdot \left[1 - \frac{C(t)}{K}\right],
\]

where $C(t)$ is the accumulated number of cases at time $t$, $r$ is the growth rate (or infection rate), and $K$ is the final size of epidemic.
Let $C_0$ be the initial number of cases: in other words, at time $t = 0$, assume that there was $C_0$ accumulated number of cases.
The solution of the *logistic* model is

\[
  C(t) = \frac{K\cdot C_0}{C_0 + (K-C_0) \, \exp(-r\,t)},
\]

which looks like a scaled *logit* model in econometrics.

## This assigment

Because we only have access to the confirmed cases that are reported, we use those figures as a proxy for the total number of cases, with the understanding that they almost surely underestimates the actual number of interest.
In what follows, we do a preliminary exploration of the data.
We then use the *logistic* model to analyze the spread of __COVID-19__ and try to predict the final number of accumulated confirmed cases for every country. 
More specifically, we

* start by focusing on modelling the spread in Switzerland;
* then apply the same approach to every country in the dataset.


<!--chapter:end:report/introduction.Rmd-->

```{r include=FALSE, cache=FALSE}
#############################################
## The following loads the needed packages ##
#############################################

# load the required packages
packages <- c(
  "here", # for the project's organization
  "tidyverse", "lubridate", # for wrangling
  "modelr", "broom", # for modeling
  "ggrepel", "gghighlight", "patchwork", "maps", # for plotting
  "knitr", "kableExtra", "bookdown", "rmarkdown" # for the report
)
purrr::walk(packages, library, character.only = TRUE)

# automatically create a bib database for R packages
write_bib(.packages(), here::here("packages.bib"))

######################################################
## The following sets a few option for nice reports ##
######################################################

# general options
options(
  digits = 3,
  str = strOptions(strict.width = "cut"),
  width = 69,
  tibble.width = 69,
  cli.unicode = FALSE
)

# ggplot options
theme_set(theme_light())

# knitr options
opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  fig.retina = 0.8, # figures are either vectors or 300 dpi diagrams
  dpi = 300,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,
  fig.show = "hold",
  message = FALSE,
  echo = FALSE
)

######################################################
## The following sets a few option for nice reports ##
######################################################

pval_star <- function (p, cutoffs = c(0.05, 0.01, 0.001)) {
  stopifnot(length(cutoffs) == 3)
  if (length(p) > 1) {
    sapply(p, pval_star, cutoffs = cutoffs)
  }
  else {
    ifelse(p > cutoffs[1], "", ifelse(p > cutoffs[2], 
                                      " *", 
                                      ifelse(p > cutoffs[3], 
                                             " **", 
                                             " ***")))
  }
}
```
# Exploratory data analysis

## Description of the state of the spread

Provide a high level description of the state of the spread. In particular, include

  * the number of days that have passed since the first confirmed case/death,
  * the current stage for confirmed cases/deaths/mortality (i.e., ratio of deaths to confirmed cases).
  
You can:

  * use either words, or tables, or figures, or a bit of each,
  * group your analysis per country, or region, or a bit of each.

```{r nice-fig, fig.cap="Here is a nice graph", out.width="80%", fig.asp=.75,fig.align='center'}


## Analyze worlwide
library(tidyverse)



covid19_data %>% group_by(date) %>% summarize(Confirmed= sum(confirmed), Deaths = sum(deaths)) %>% ggplot() +
geom_line(aes(x=date, y= Confirmed, col="Confirmed"))+
geom_line(aes(x=date, y=Deaths, col="Deaths")) +
  scale_x_date(date_breaks = "1 week", date_labels = "%b %d" )+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Higly increase for the confirmed case", subtitle = "Worldwide representation", x= "Date",y= "People", caption = "data from jh_covid19_data_2020-04-06.csv")

covid19_data <- covid19_data %>% mutate(ratio=(deaths/confirmed))
covid19_data$ratio[is.nan(covid19_data$ratio)]<-0


covid19_data %>% group_by(date) %>% summarize(Mean_Ratio = mean(ratio)) %>% ggplot() +
  geom_line(aes(x=date, y=Mean_Ratio))  +
  scale_x_date(date_breaks = "1 week", date_labels = "%b %d" ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
   labs(title = "Highly increase in the ratio deaths/confirmed", subtitle = "Worldwide representation", x= "Date",y= "Ratio", caption = "data from jh_covid19_data_2020-04-06.csv")


### Filer by Region


 covid19_data %>% group_by(date,region) %>% summarize(Confirmed= sum(confirmed)) %>% ggplot(aes(x=date, y= Confirmed, colour= region)) +
  geom_line() +
   labs(title = "Flat increase and early deperature in confirmed case in the East Asia & Pacific", subtitle = "Worldwide representation group by region", x= "Date",y= "Confirmed case", caption = "data from jh_covid19_data_2020-04-06.csv")+
   scale_x_date(date_breaks = "1 week", date_labels = "%b %d" ) +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))

 covid19_data %>% group_by(date,region) %>% summarize(Deaths= sum(deaths)) %>% ggplot(aes(x=date, y= Deaths, colour= region)) +
  geom_line() +
 labs(title = "Exponential curve for the deaths in the region of Europe & Central Asia", subtitle = "Worldwide representation group by region", x= "Date",y= "Deaths", caption = "data from jh_covid19_data_2020-04-06.csv") +
   scale_x_date(date_breaks = "1 week", date_labels = "%b %d" ) +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))
 
  covid19_data %>% group_by(date,region) %>% summarize(Mean_ratio = mean(ratio)) %>%
    ggplot(aes(x=date, y= Mean_ratio, colour= region)) +
  geom_line()+
  labs(title = "We observe an increase pattern in term of the ratio  deaths/confirmed ", subtitle = "Worldwide representation groupy by region", x= "Date",y= "Deaths/Confirmed", caption = "data from jh_covid19_data_2020-04-06.csv") +
   scale_x_date(date_breaks = "1 week", date_labels = "%b %d" ) +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))
  

```


## Worldwide map

Produce a worlwide map of the __COVID-19__ spread at the latest date available in `covid19_data` for each country, and describe what you see.

Hint: `ggplot2` package includes two helpful command for this part, namely

  * `map_data()` to retrieve a map,
  * and `geom_map()` to draw a map on a plot.
  
Use `expand_limits` to make sure you display the whole map of the world.

```{r}
library(ggplot2)
library(dplyr)
require(maps)
require(viridis)

worldmap <- map_data("world") %>%  rename(country=region)




datagraph1 <-  left_join(covid_19_data_04_06, worldmap,"country")
ggplot(datagraph1) + 
  geom_polygon(data=datagraph1, aes(x=datagraph1$long, y=datagraph1$lat, group = group, fill= confirmed),colour="white") +
   labs(
    x = "Longitudes",
    y = "Latitudes",
    title = "Dissimilarity in worldwide temperature in March 2010", color = "temperature"
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.6))+
  scale_fill_viridis_c(option = "C")

```

## Data selection and alignment


To compare the speed of the infection spread between countries, we need to "align" the data. In other words, we model the epidemic using equivalent "starting conditions" for every country. To do that, we filter the data so that the number of confirmed cases (in any country) is greater or equal to the maximal number of confirmed cases at the first day of a specific country. 

Let $C_{d, i}$ be the number of accumulated confirmed cases on day $d$ for country $i$. Let country $k$ be the one such that it had the highest number of reported cases on the first day in the dataset, that is $C_{1, k} \geq C_{1, i}$ for any other $i$. Find $k$ and discuss.

From `covid19_data`, extract a new table `covid19_data_filtered`:

* Select only the countries $i$, which on some day $d_{0,i}$ have $C_{d_{0,i}, i} \geq C_{0, k}$. We will call this time $d_{0,i}$ a day-zero for country $i$. In the next sections, we model $C_i(t) = C_{d_{0,i} + t,i}$, that is the spread of the epidemic in country $i$ with $t$ representing "event days". Remember, for every country the day-zero is, in general, different. However, when a country entered the epidemic stage, we are only interested in number of days that has passed from the date of entry (i.e. day-zero).
* Remove countries who are left with less than two weeks of data, i.e. we keep those countries whose number of days that has passed from the day-zero of this country is 14 or more. 
* Create a new column called `t` representing the number of days from the day-zero of this country.
* Create a new column called `confirmed_1e5pop` representing the number of confirmed cases per 100,000 habitants. This is useful in order to compare how the spread of the epidemic differs between countries relative to their population.

Discuss using either tables or visualizations or both: 

* Which countries are left in `covid19_data_filtered`?
* What is the state of the spread there?
* What is the relationship between `t` and `confirmed_1e5pop`?

```{r}
## your code goes here
```

<!--chapter:end:report/eda.Rmd-->

```{r include=FALSE, cache=FALSE}
#############################################
## The following loads the needed packages ##
#############################################

# load the required packages
packages <- c(
  "here", # for the project's organization
  "tidyverse", "lubridate", # for wrangling
  "modelr", "broom", # for modeling
  "ggrepel", "gghighlight", "patchwork", "maps", # for plotting
  "knitr", "kableExtra", "bookdown", "rmarkdown" # for the report
)
purrr::walk(packages, library, character.only = TRUE)

# automatically create a bib database for R packages
write_bib(.packages(), here::here("packages.bib"))

######################################################
## The following sets a few option for nice reports ##
######################################################

# general options
options(
  digits = 3,
  str = strOptions(strict.width = "cut"),
  width = 69,
  tibble.width = 69,
  cli.unicode = FALSE
)

# ggplot options
theme_set(theme_light())

# knitr options
opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  fig.retina = 0.8, # figures are either vectors or 300 dpi diagrams
  dpi = 300,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,
  fig.show = "hold",
  message = FALSE,
  echo = FALSE
)

######################################################
## The following sets a few option for nice reports ##
######################################################

pval_star <- function (p, cutoffs = c(0.05, 0.01, 0.001)) {
  stopifnot(length(cutoffs) == 3)
  if (length(p) > 1) {
    sapply(p, pval_star, cutoffs = cutoffs)
  }
  else {
    ifelse(p > cutoffs[1], "", ifelse(p > cutoffs[2], 
                                      " *", 
                                      ifelse(p > cutoffs[3], 
                                             " **", 
                                             " ***")))
  }
}
```
# Modeling the spread of COVID-19 in a single country

## The logistic model in R

Using the filtered dataset, we study the spread of COVID-19 with the logistic model.
Letting $C_{i}(t) = C_{d_{0,i} + t,i}$, the model for country $i$ can be expressed as:

\[
  C_{i}(t) = \frac{K_{i} \cdot C_{i}(0)}{C_{i}(0) + (K_{i}-C_{i}(0)) \, \exp(-R_{i}\,t)}
\]

The goal is to find the final number of cases $K_{i}$ and the infection rate $R_{i}$. We implement this in R using the following function:

```{r, echo = TRUE}
# here, we assume that data is a data frame with two variables
#  - t: the number of event days
#  - confirmed: the number of confirmed cases at time t
logistic_model <- function(data) {
  data <- data %>% arrange(t)
  C_0 <- data$confirmed[1]
  C_max <- data$confirmed[nrow(data)]
  nls(
    formula = confirmed ~ K / (1 + ((K - C_0) / C_0) * exp(-R * t)),
    data = data,
    start = list(K = 2 * C_max, R = 0.5),
    control = nls.control(minFactor = 1e-6, maxiter = 100)
  )
}
```

Notice:

* We use the nonlinear least square method `stats::nls` to fit the unknown parameters.
* In R, the formula above is `confirmed ~ K / (1 + ((K - C_0)/C_0) * exp(-R * t))`.
* As starting point $(K_0, R_0)$ for the optimiser, we set $R_0 = 0.5$ and $K_0 = 2 \, C(t^*)$, where $t^*$ is the latest information about accumulated confirmed cases.
* We further set the `control` argument as `nls.control(minFactor = 1e-6, maxiter = 100)`.

## The logistic model applied to data from Switzerland

From `covid19_data_filtered`, extract a table `covid19_ch` which corresponds to data for Switzerland.
Then:

* Use the function above to fit the logistic model for Switzerland
* Describe its output (fitted parameters, `broom::tidy()` might be useful here)
* Discuss the goodness-of-fit.
* Plot the fitted curve, as well as observed data points. 
* Present the predictions of the model. What is the estimated final size of the epidemic and infection rate in Switzerland?

```{r}
## your code goes here
```

<!--chapter:end:report/swiss_model.Rmd-->

```{r include=FALSE, cache=FALSE}
#############################################
## The following loads the needed packages ##
#############################################

# load the required packages
packages <- c(
  "here", # for the project's organization
  "tidyverse", "lubridate", # for wrangling
  "modelr", "broom", # for modeling
  "ggrepel", "gghighlight", "patchwork", "maps", # for plotting
  "knitr", "kableExtra", "bookdown", "rmarkdown" # for the report
)
purrr::walk(packages, library, character.only = TRUE)

# automatically create a bib database for R packages
write_bib(.packages(), here::here("packages.bib"))

######################################################
## The following sets a few option for nice reports ##
######################################################

# general options
options(
  digits = 3,
  str = strOptions(strict.width = "cut"),
  width = 69,
  tibble.width = 69,
  cli.unicode = FALSE
)

# ggplot options
theme_set(theme_light())

# knitr options
opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  fig.retina = 0.8, # figures are either vectors or 300 dpi diagrams
  dpi = 300,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,
  fig.show = "hold",
  message = FALSE,
  echo = FALSE
)

######################################################
## The following sets a few option for nice reports ##
######################################################

pval_star <- function (p, cutoffs = c(0.05, 0.01, 0.001)) {
  stopifnot(length(cutoffs) == 3)
  if (length(p) > 1) {
    sapply(p, pval_star, cutoffs = cutoffs)
  }
  else {
    ifelse(p > cutoffs[1], "", ifelse(p > cutoffs[2], 
                                      " *", 
                                      ifelse(p > cutoffs[3], 
                                             " **", 
                                             " ***")))
  }
}
```
# Modeling the spread of COVID-19 worldwide

In this section, we fit the logistic model to every country in the `covid19_data_filtered` dataset.

## Fitting the logistic model to every country

Use nested data, list-columns and `logistic_model` to fit the logistic model to every country in the dataset.
Because, for some countries, the optimization method might not converge, you can use `possibly()` or something similar.
For which country does the optimization fail ?
Assess the goodness-of-fit of the logistic model in the various countries.

```{r}
## your code goes here
```

## Fitted parameters and long-term predictions

Describe the fitted parameters (i.e., the final size and the infection rates), both on a per-country basis and some aggregate numbers (e.g., total size of the epidemic over all considered countries).
Furthermore, study the evolution (say for $t$ from 0 to 50) of the predictions of the number of confirmed cases from your models.
Similarly as was discussed in the last sub-section of the exploratory data analysis, the number of confirmed cases per 100,000 habitants is also important to understand how specific countries are managing the spread of the epidemic.
Thus, predict the evolution of this number (i.e., by dividing your predictions for confirmed cases by the population size) and discuss.

Hints:

* Format the fitted parameters using `broom::tidy()`.
* For the long-term predictions, you can use `data = data.frame(t = 0:50)` in `add_predictions()`.

```{r}
## your code goes here
```

<!--chapter:end:report/many_models.Rmd-->

```{r include=FALSE, cache=FALSE}
#############################################
## The following loads the needed packages ##
#############################################

# load the required packages
packages <- c(
  "here", # for the project's organization
  "tidyverse", "lubridate", # for wrangling
  "modelr", "broom", # for modeling
  "ggrepel", "gghighlight", "patchwork", "maps", # for plotting
  "knitr", "kableExtra", "bookdown", "rmarkdown" # for the report
)
purrr::walk(packages, library, character.only = TRUE)

# automatically create a bib database for R packages
write_bib(.packages(), here::here("packages.bib"))

######################################################
## The following sets a few option for nice reports ##
######################################################

# general options
options(
  digits = 3,
  str = strOptions(strict.width = "cut"),
  width = 69,
  tibble.width = 69,
  cli.unicode = FALSE
)

# ggplot options
theme_set(theme_light())

# knitr options
opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  fig.retina = 0.8, # figures are either vectors or 300 dpi diagrams
  dpi = 300,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,
  fig.show = "hold",
  message = FALSE,
  echo = FALSE
)

######################################################
## The following sets a few option for nice reports ##
######################################################

pval_star <- function (p, cutoffs = c(0.05, 0.01, 0.001)) {
  stopifnot(length(cutoffs) == 3)
  if (length(p) > 1) {
    sapply(p, pval_star, cutoffs = cutoffs)
  }
  else {
    ifelse(p > cutoffs[1], "", ifelse(p > cutoffs[2], 
                                      " *", 
                                      ifelse(p > cutoffs[3], 
                                             " **", 
                                             " ***")))
  }
}
```
`r if (knitr:::is_html_output()) '
# References {-}
'`

<!--chapter:end:report/references.Rmd-->

