# Modeling the spread of COVID-19 worldwide

In this section, we fit the logistic model to every country in the `covid19_data_filtered` dataset.

## Fitting the logistic model to every country

Use nested data, list-columns and `logistic_model` to fit the logistic model to every country in the dataset.
Because, for some countries, the optimization method might not converge, you can use `possibly()` or something similar.
For which country does the optimization fail ?
Assess the goodness-of-fit of the logistic model in the various countries.

```{r table 5, warning=FALSE, message=FALSE, echo = FALSE}


by_country <- covid19_data_filtered %>%
              group_by(country) %>%
              nest()

tmp <- by_country %>%
         mutate(log_model = purrr::map(data, possibly(logistic_model, NA))) %>%   filter(!is.na(log_model))


fitted_model <- tmp %>% 
                mutate(aug = purrr::map(log_model, augment)) %>%
                 unnest(aug)

tmp %>%
  mutate(tdy = purrr::map(log_model, tidy)) %>%
  unnest(tdy) %>%
  select(country,term,estimate,std.error) %>%
  kable(
    caption = "List of the K and R for each country of our model"
       ) %>%
  kable_styling(
    bootstrap_options = "striped")
```

In this table, we observe, for each country, the number of confirmed case with the "K" and the infection rate with the "K". 
We notice that the Japan doesn't figure in this table. 


In order to assess the goodness-of-fit of the logistic model in the various countries, we plot the residuals of our predictions. 
```{r fig-14, fig.cap="Figure 14", out.width="80%", fig.asp=.75,fig.align='center', warning=FALSE, message=FALSE, echo = FALSE}

fitted_model %>%
  ggplot(aes(t,.resid)) +
  geom_line(aes(colour=country), alpha=1/3) +
  labs(
    title = "Increase of the error with the time dimension",
    subtitle = "Prediction of the evolution - COVID-19",
    x= "Time dimension(day)",
    y="Residuals",
    colour="Country"
  )

```
In this plot, we observe that the resdiduals increase with the time dimension, which it's not surprising.

## Fitted parameters and long-term predictions

Describe the fitted parameters (i.e., the final size and the infection rates), both on a per-country basis and some aggregate numbers (e.g., total size of the epidemic over all considered countries).
Furthermore, study the evolution (say for $t$ from 0 to 50) of the predictions of the number of confirmed cases from your models.
Similarly as was discussed in the last sub-section of the exploratory data analysis, the number of confirmed cases per 100,000 habitants is also important to understand how specific countries are managing the spread of the epidemic.
Thus, predict the evolution of this number (i.e., by dividing your predictions for confirmed cases by the population size) and discuss.

Hints:

* Format the fitted parameters using `broom::tidy()`.
* For the long-term predictions, you can use `data = data.frame(t = 0:50)` in `add_predictions()`.

```{r fig-15, fig.cap="Figure 15", out.width="80%", fig.asp=.75,fig.align='center', warning=FALSE, message=FALSE, echo = FALSE}
fitted_model_2<- fitted_model %>% filter(t<=50)

best_in_each_fitted <- fitted_model_2 %>%
                      group_by(country) %>% filter(row_number(desc(.fitted ))==1) 


fitted_model_2 %>%
  ggplot(aes(t,.fitted)) +
  geom_line(aes(colour=country),alpha=1/3) +
  labs( 
    title = "Exponential confirmed case prediction for the USA",
    subtitle ="Prediction of the evolution COVID-19",
    x= "Day",
    y="Prediction for the confirmed case") 


```
In this plot, we observe an increase with the time regarding our predicted confirmed case.


But in order to better undersant which curve correspond to which country, we add the country name for each curve.
```{r fig-16, fig.cap="Figure 16", out.width="80%", fig.asp=.75,fig.align='center', warning=FALSE, message=FALSE, echo = FALSE}

fitted_model_2 %>%
  ggplot(aes(t,.fitted)) +
  geom_line(aes(colour=country),alpha=1/3) +
  geom_text(aes(label=country), data = best_in_each_fitted) +
  labs( 
    title = "Exponential confirmed case prediction for the USA",
    subtitle ="Prediction of the evolution COVID-19",
    x= "Day",
    y="Prediction for the confirmed case") 

```
Therefore, we notice that the exponentital curve correspond to the USA.

To better evaluate the evolution, we poursuive the same analysis but regarding to the population if each country, in order to better visualize the problematic.
```{r fig-17, fig.cap="Figure 17", out.width="80%", fig.asp=.75,fig.align='center', warning=FALSE, message=FALSE, echo = FALSE}
joined<-left_join(
  covid19_data_filtered %>% select(population,country),
  fitted_model_2 %>% select(-data,-log_model),
  by= "country"
  ) %>%
  mutate(ratio_pop =.fitted /population)

best_in_each <- joined %>%
                group_by(country) %>%
                filter(row_number(desc(ratio_pop))==1)

joined %>% ggplot(aes(t,ratio_pop))+
  geom_line(aes(colour=country),alpha=1/3)+
  geom_text(aes(label=country), data = best_in_each)+
  labs(
    title = "Luxembourg and Icelan \nexponential curve for the COVID-19",
    subtile ="Prediction for the confirmed case relative \n to the population",
    x= "Day",
    y="Prediction of the confirmed case/Population",
    colour="Country"
    ) 

```
When we look the number of case proportional to the population, we notice that the plot isn't the same as before, and that now the exponential curve corresponf to  Luxembrug and Iceland.
